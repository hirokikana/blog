---
layout: post
title: DNS パケットフォーマット
date: 2019/10/13 15:00:00 +09:00
type: post
published: false
status: publish
categories:
- dev
tags:
- DNS
---

## DNSメッセージフォーマットの概要
[RFC 1035 4.1 Format](https://tools.ietf.org/html/rfc1035#section-4.1) にDNSパケットのフォーマットが定義されています。
下記はパケットの構成を示した図の引用です。
```
    +---------------------+
    |        Header       |
    +---------------------+
    |       Question      | the question for the name server
    +---------------------+
    |        Answer       | RRs answering the question
    +---------------------+
    |      Authority      | RRs pointing toward an authority
    +---------------------+
    |      Additional     | RRs holding additional information
    +---------------------+
```

とりあえず正引きができれば良いという目的から、Header / Question / Answerのみに今回は注目しました。
かなり雑な列挙ですが、ひとまずこれがわかればなんとなくどうにかなります……。

### Header セクション
Header セクションはDNSパケットには必ず存在し、パケットの内容についての情報が格納されています。

[RFC 1035 4.1.1. Header section format](https://tools.ietf.org/html/rfc1035#section-4.1.1)からHeader セクションの構成について引用した図こちらです。
```
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                      ID                       |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                    QDCOUNT                    |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                    ANCOUNT                    |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                    NSCOUNT                    |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                    ARCOUNT                    |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```
ID / QDCOUNT / ANCOUNT / NSCOUNT / ARCOUNTはそれぞれ16bit(2byte)で、IDの後方16bitにフラグ群が含まれています。
すべての項目について説明することが望ましいのですが、今回はレスポンスメッセージを作る際に意識する必要があった部分だけ列挙します。
 - ID
   - 問い合わせごとに付与されるID
   - リクエスト元はこのIDが送ったときと同一であるかを確認するので、レスポンスには同じリクエストと同じIDを付与する
 - QR
   - 0は問い合わせ、1はレスポンス
 - RCODE
   - レスポンスコード。正常な場合は0
 - QDCOUNT
   - Question セクションのエントリー数
 - ANCOUNT
   - Answer セクションのエントリー数

### Question セクション
どのような内容の問い合わせであるかを格納するセクションです。
ヘッダ内のQDCOUNT には、このQestion セクションのエントリー数が保存されています。
このセクションは、その内容から多くの場合は1つなので、QDCOUNT も多くの場合は1です。

Question セクションはQNAME / QTYPE / QCLASS の3つから構成されています。

 - QNAME
   - ドメイン名の情報がラベル(FQDNを.で分割した文字列)という単位で分割されている
   - 1オクテット(8bit = 1byte)目にラベルの長さが定義され、ラベル本体と続く
   - 1オクテットの0がQNAMEの末尾のマーク
 - QTYPE
   - 問い合わせレコードのタイプ
   - Aレコードの場合は1
   - 詳細はこちら [3.2.2. TYPE values](https://tools.ietf.org/html/rfc1035#section-3.2.2)
 - QCLASS
   - 問い合わせレコードのクラス
   - 概ねはインターネットを示すINなので1

### Answer セクション
問い合わせを受けて、正常に引けた場合の返答となるリソースレコード(RFC 1035 ではRRと書かれています)を格納するセクションです。
リソースレコードのフォーマットについてRFC 1035から引用した図はこちらです。
```
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                                               |
    /                                               /
    /                      NAME                     /
    |                                               |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                      TYPE                     |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                     CLASS                     |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                      TTL                      |
    |                                               |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                   RDLENGTH                    |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--|
    /                     RDATA                     /
    /                                               /
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

それぞれのフィールドは下記のような意味があります。
 - NAME
   - レコードのドメイン名
   - フォーマットはQNAMEと同一
 - TYPE
   - レコードのタイプ
   - フォーマットはQTYPEと同一
 - CLASS
   - レコードのクラス
   - フォーマットはQCLASSと同一
 - TTL
   - レコードの有効期限(秒)
 - RDLENGTH
   - リソースデータの長さ
   - IPv4アドレスの場合は4オクテット
 - RDATA
   - 実際のレコードのデータ



## femtoDNSの概要
ここまで私がDNSメッセージのフォーマットについてかなり端折って紹介しましたが、ここまでの理解でDNSサーバー

## 参考サイト
 - [RFC 1035 - Domain names - implementation and specification](https://tools.ietf.org/html/rfc1035)
 - [DNS Tips：DNSパケットフォーマットと、DNSパケットの作り方 (1/2)](https://www.atmarkit.co.jp/ait/articles/1601/29/news014.html)
 
